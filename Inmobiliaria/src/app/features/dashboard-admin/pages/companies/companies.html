<div class="container">
  <!-- Header -->
  <div class="pageHeader">
    <div>
      <h1 class="pageTitle">Gestión de Empresas</h1>
      <p class="pageSubtitle">Administra las compañías y sus datos principales</p>
    </div>

    <div class="headerActions">
      <button class="opcion" (click)="newCompany()">
        <span-lucide name="plus" size="18"></span-lucide>
        <span class="label">Crear Empresa</span>
      </button>

      <button class="botonExportar"
              [disabled]="exportando || filtered.length === 0"
              (click)="handleExportar()">
        <span-lucide *ngIf="exportando" name="loader-2" class="iconoRotando" size="20" strokeWidth="2"></span-lucide>
        <span-lucide *ngIf="!exportando" name="file-down" size="20" strokeWidth="2"></span-lucide>
        <span>{{ exportando ? 'Exportando...' : 'Exportar a Excel' }}</span>
      </button>
    </div>
  </div>

  <!-- Tarjetas estadísticas -->
  <div class="estadisticasGrid">
    <div class="tarjeta" *ngFor="let stat of estadisticas">
      <div class="contenido">
        <div class="textos">
          <p class="titulo">{{ stat.titulo }}</p>
          <h2 class="valor">{{ stat.valor }}</h2>
        </div>
        <div class="iconoContainer" [ngStyle]="{ 'background-color': stat.color }">
          <span-lucide [name]="stat.icon" size="24" strokeWidth="2.5"></span-lucide>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="selector" style="margin-bottom: 16px;">
    <div class="opcion" style="justify-content:flex-start;background:#fff;border:1px solid #f1f5f9;gap:8px;">
      <span-lucide name="search" size="18" class="icono"></span-lucide>
      <input type="text" placeholder="Buscar por nombre, RUC, correo o dirección..."
             [(ngModel)]="searchTerm"
             style="width:100%;border:none;outline:none;background:transparent;color:#0f172a;" />
    </div>
  </div>

  <!-- Tabla -->
  <div class="tablaWrapper" *ngIf="!loading && filtered.length; else estadoTpl">
    <table class="tabla">
      <thead>
        <tr>
          <th class="headerCell">Logo</th>
          <th class="headerCell">Empresa</th>
          <th class="headerCell">RUC</th>
          <th class="headerCell">Correo</th>
          <th class="headerCell">Teléfono</th>
          <th class="headerCell">Usuario</th>
          <th class="headerCell">Tipo Empresa</th>
          <th class="headerCell">Fecha Registro</th>
          <th class="headerCell">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr class="fila" *ngFor="let c of filtered">
          <td class="celda">
            <img [src]="c.logo || '/placeholder.svg'" [alt]="c.nombre" class="logo" />
          </td>
          <td class="celda">
            <div class="contenidoCorto" title="{{ c.nombre }}">{{ c.nombre }}</div>
            <div class="subInfo">{{ c.direccion }}</div>
          </td>
          <td class="celda">{{ c.ruc }}</td>
          <td class="celda">
            <a [href]="'mailto:'+c.correo" class="linkCorreo">{{ c.correo }}</a>
          </td>
          <td class="celda">{{ c.telefono }}</td>
          <td class="celda">
            <span class="badge aprobado">{{ c.nombreUsuario }}</span>
          </td>
          <td class="celda">
            <span class="badge">{{ c.tipoEmpresa }}</span>
          </td>
          <td class="celda">{{ c.fechaRegistro }}</td>
          <td class="celda">
            <button class="opcion btnTabla" title="Ver detalles" (click)="abrirDetalle(c)">
              <span-lucide name="eye" size="18"></span-lucide>
            </button>
            <button class="opcion btnTabla" title="Editar" (click)="editCompany(c)">
              <span-lucide name="edit-2" size="18"></span-lucide>
            </button>
            <button class="opcion btnTabla peligro" title="Eliminar" (click)="abrirEliminar(c)">
              <span-lucide name="trash-2" size="18"></span-lucide>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #estadoTpl>
    <div *ngIf="loading" class="contenedorVacio">
      <span-lucide name="loader-2" size="48" class="iconoRotando" style="margin-bottom:16px;"></span-lucide>
      <p class="mensajeVacio">Cargando empresas...</p>
    </div>
    <div *ngIf="!loading && !filtered.length" class="contenedorVacio">
      <span-lucide name="building-2" size="48" style="margin-bottom:16px;color:#94a3b8;"></span-lucide>
      <p class="mensajeVacio">No se encontraron empresas</p>
      <button class="opcion outline" (click)="newCompany()" style="margin-top:16px;">
        <span-lucide name="plus" size="18"></span-lucide>
        Crear Primera Empresa
      </button>
    </div>
  </ng-template>

  <!-- Modal Detalle -->
  <div class="overlay" *ngIf="showDetails && selected as sel">
    <div class="modal">
      <div class="imagenContainer empresa">
        <img [src]="sel.logo || '/placeholder.svg'" [alt]="sel.nombre" class="imagen" />
      </div>

      <div class="contenido body">
        <h2 class="pageTitle sm">{{ sel.nombre }}</h2>
        <div class="badgesRow">
          <span class="badge aprobado">{{ sel.tipoEmpresa }}</span>
          <span class="badge code">{{ sel.ruc }}</span>
        </div>

        <div class="descripcionBox">
          <p class="descText">{{ sel.direccion }}</p>
        </div>

        <div>
          <h3 class="titulo">Información</h3>
          <div class="detallesGrid">
            <p class="celda"><strong>Usuario asignado:</strong> {{ sel.nombreUsuario }}</p>
            <p class="celda"><strong>Correo:</strong> {{ sel.correo }}</p>
            <p class="celda"><strong>Teléfono:</strong> {{ sel.telefono }}</p>
            <p class="celda"><strong>Tipo empresa:</strong> {{ sel.tipoEmpresa }}</p>
            <p class="celda"><strong>Fecha registro:</strong> {{ sel.fechaRegistro }}</p>
          </div>
        </div>
      </div>

      <div class="footer">
        <button (click)="cerrarDetalle()" class="opcion outline">✖ Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar -->
  <div class="overlay" *ngIf="showDelete && selected as selDel">
    <div class="modal soloBody">
      <div class="contenido body">
        <span-lucide name="alert-triangle" size="48" style="color:#ef4444;margin-bottom:16px;"></span-lucide>
        <h2 class="pageTitle sm">Eliminar Empresa</h2>
        <p>¿Seguro que deseas eliminar <strong>{{ selDel.nombre }}</strong> ({{ selDel.ruc }})?</p>
        <p style="color:#64748b;font-size:14px;margin-top:8px;">Esta acción no se puede deshacer.</p>
        <div class="endRow" style="margin-top:24px;">
          <button (click)="cerrarEliminar()" class="opcion outline">Cancelar</button>
          <button (click)="confirmarEliminar()" class="opcion danger">
            <span-lucide name="trash-2" size="18"></span-lucide>
            <span class="label">Eliminar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar -->
  <div class="overlay" *ngIf="showForm">
    <div class="modal formModal">
      <div class="contenido body">
        <div class="headRow">
          <h2 class="pageTitle sm">{{ editing ? 'Editar Empresa' : 'Crear Empresa' }}</h2>
          <button class="opcion outline" (click)="closeForm()">✖</button>
        </div>

        <div class="selector column">
          <!-- Logo (opcional - el backend no lo soporta aún) -->
          <div class="opcion field">
            <div class="wfull">
              <label class="pageSubtitle">Logo (Próximamente)</label>
              <div class="logoPicker">
                <div class="logoPreview">
                  <img [src]="imagePreview || formData.logo || '/placeholder.svg'" alt="Preview" class="logoImg" />
                </div>
                <div class="logoActions">
                  <input type="file"
                         id="logoFile"
                         accept="image/*"
                         (change)="onFileChange($event)"
                         class="fileHidden"
                         disabled />
                  <label for="logoFile" class="opcion outline" style="opacity:0.5;cursor:not-allowed;">
                    Seleccionar imagen (Próximamente)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ NUEVO: Campo de Usuario Asignado -->
          <div class="opcion field">
            <div class="wfull">
              <label class="pageSubtitle">Usuario Asignado *</label>
              <div class="userSearchContainer">
                <div class="userSearchWrapper">
                  <span-lucide name="user" size="18" class="searchInputIcon"></span-lucide>
                  <input type="text"
                         [(ngModel)]="busquedaUsuario"
                         (ngModelChange)="onBusquedaUsuarioChange()"
                         (focus)="mostrarDropdownUsuario = true"
                         [class.inputError]="!!errors.idUsuario"
                         class="input"
                         placeholder="Buscar usuario por nombre, email o DNI..."
                         autocomplete="off" />
                  <button *ngIf="usuarioSeleccionado"
                          type="button"
                          (click)="limpiarUsuario()"
                          class="clearButton"
                          title="Limpiar selección">
                    <span-lucide name="x" size="16"></span-lucide>
                  </button>
                </div>

                <!-- Dropdown de resultados -->
                <div *ngIf="mostrarDropdownUsuario && busquedaUsuario && usuariosFiltrados.length"
                     class="userDropdown">
                  <button *ngFor="let usuario of usuariosFiltrados"
                          type="button"
                          (click)="seleccionarUsuario(usuario)"
                          class="userDropdownItem">
                    <div class="userAvatar">
                      <span-lucide name="user" size="16"></span-lucide>
                    </div>
                    <div class="userInfo">
                      <span class="userName">{{ usuario.nombre }}</span>
                      <span class="userMeta">{{ usuario.email }} • DNI: {{ usuario.dni }}</span>
                    </div>
                  </button>
                </div>

                <!-- Usuario seleccionado -->
                <div *ngIf="usuarioSeleccionado" class="userSelected">
                  <div class="userSelectedContent">
                    <span-lucide name="check-circle" size="18" style="color:#10b981;"></span-lucide>
                    <div>
                      <div class="userSelectedName">{{ usuarioSeleccionado.nombre }}</div>
                      <div class="userSelectedEmail">{{ usuarioSeleccionado.email }}</div>
                    </div>
                  </div>
                  <span class="badge aprobado">Seleccionado</span>
                </div>

                <span *ngIf="errors.idUsuario" class="badge rechazado">{{ errors.idUsuario }}</span>
              </div>
            </div>
          </div>

          <!-- Campos requeridos -->
          <div class="grid2">
            <div class="opcion field">
              <div class="wfull">
                <label class="pageSubtitle">Nombre *</label>
                <input type="text"
                       [(ngModel)]="formData.nombre"
                       (ngModelChange)="clearError('nombre')"
                       [class.inputError]="!!errors.nombre"
                       class="input"
                       placeholder="Ej: IdealHome SAC" />
                <span *ngIf="errors.nombre" class="badge rechazado">{{ errors.nombre }}</span>
              </div>
            </div>
            <div class="opcion field">
              <div class="wfull">
                <label class="pageSubtitle">RUC *</label>
                <input type="text"
                       [(ngModel)]="formData.ruc"
                       (ngModelChange)="clearError('ruc')"
                       [class.inputError]="!!errors.ruc"
                       class="input"
                       maxlength="11"
                       placeholder="Ej: 20481234567" />
                <span *ngIf="errors.ruc" class="badge rechazado">{{ errors.ruc }}</span>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="opcion field">
              <div class="wfull">
                <label class="pageSubtitle">Correo *</label>
                <input type="email"
                       [(ngModel)]="formData.correo"
                       (ngModelChange)="clearError('correo')"
                       [class.inputError]="!!errors.correo"
                       class="input"
                       placeholder="Ej: contacto@empresa.com" />
                <span *ngIf="errors.correo" class="badge rechazado">{{ errors.correo }}</span>
              </div>
            </div>
            <div class="opcion field">
              <div class="wfull">
                <label class="pageSubtitle">Teléfono *</label>
                <input type="text"
                       [(ngModel)]="formData.telefono"
                       (ngModelChange)="clearError('telefono')"
                       [class.inputError]="!!errors.telefono"
                       class="input"
                       maxlength="9"
                       placeholder="Ej: 987654321" />
                <span *ngIf="errors.telefono" class="badge rechazado">{{ errors.telefono }}</span>
              </div>
            </div>
          </div>

          <div class="opcion field">
            <div class="wfull">
              <label class="pageSubtitle">Dirección *</label>
              <input type="text"
                     [(ngModel)]="formData.direccion"
                     (ngModelChange)="clearError('direccion')"
                     [class.inputError]="!!errors.direccion"
                     class="input"
                     placeholder="Ej: Av. Principal 123, Lima" />
              <span *ngIf="errors.direccion" class="badge rechazado">{{ errors.direccion }}</span>
            </div>
          </div>

          <div class="opcion field">
            <div class="wfull">
              <label class="pageSubtitle">Tipo de Empresa</label>
              <input type="text"
                     [(ngModel)]="formData.tipoEmpresa"
                     (ngModelChange)="clearError('tipoEmpresa')"
                     class="input"
                     placeholder="Ej: SAC, SRL, EIRL, Persona Natural" />
              <span *ngIf="errors.tipoEmpresa" class="badge rechazado">{{ errors.tipoEmpresa }}</span>
            </div>
          </div>

          <div class="endRow">
            <button class="opcion outline" (click)="closeForm()">Cancelar</button>
            <button class="opcion primary" (click)="submitForm()">
              <span-lucide name="loader-2" size="16" *ngIf="loading" class="iconoRotando"></span-lucide>
              <span-lucide name="plus" size="16" *ngIf="!editing && !loading"></span-lucide>
              <span-lucide name="save" size="16" *ngIf="editing && !loading"></span-lucide>
              {{ editing ? 'Guardar Cambios' : 'Crear Empresa' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
