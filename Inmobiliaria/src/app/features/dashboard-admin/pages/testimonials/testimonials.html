<!-- Contenedor Principal -->
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-info">
      <h1 class="title">Gestión de Testimonios</h1>
      <p class="subtitle">Administra testimonios recibidos y publicaciones</p>
    </div>
    <button class="btn-enviar" (click)="abrirModalEnviar()">
      <lucide-icon name="send" [size]="18"></lucide-icon>
      <span>Enviar Formulario</span>
    </button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab"
            [class.tab-active]="activeTab === 'recepcion'"
            (click)="activeTab = 'recepcion'">
      <lucide-icon name="inbox" [size]="18"></lucide-icon>
      <span>Recepción</span>
      <span class="badge" *ngIf="testimoniosRecibidos.length > 0">
        {{ testimoniosRecibidos.length }}
      </span>
    </button>
    <button class="tab"
            [class.tab-active]="activeTab === 'publicaciones'"
            (click)="activeTab = 'publicaciones'">
      <lucide-icon name="star" [size]="18"></lucide-icon>
      <span>Publicaciones</span>
      <span class="badge-info" *ngIf="testimoniosPublicados.length > 0">
        {{ testimoniosPublicados.length }}
      </span>
    </button>
  </div>

  <!-- Tab Content: Recepción -->
  <div *ngIf="activeTab === 'recepcion'" class="tab-content">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando testimonios...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && testimoniosRecibidos.length === 0" class="empty-state">
      <lucide-icon name="inbox" [size]="48" class="empty-icon"></lucide-icon>
      <p class="empty-title">No hay testimonios recibidos</p>
      <p class="empty-text">Los testimonios enviados por los clientes aparecerán aquí</p>
      <button class="btn-primary" (click)="abrirModalEnviar()">
        <lucide-icon name="send" [size]="18"></lucide-icon>
        <span>Enviar Primer Formulario</span>
      </button>
    </div>

    <!-- Tabla de Testimonios Recibidos -->
    <div *ngIf="!loading && testimoniosRecibidos.length > 0" class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Testimonio</th>
            <th>Valoración</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let testimonio of testimoniosRecibidos">
            <!-- Cliente -->
            <td>
              <div class="cliente-info">
                <div class="avatar">{{ getInitials(testimonio.nombreCompleto) }}</div>
                <div class="cliente-data">
                  <p class="cliente-nombre">{{ testimonio.nombreCompleto }}</p>
                  <p class="cliente-email">{{ testimonio.email }}</p>
                </div>
              </div>
            </td>

            <!-- Testimonio -->
            <td>
              <p class="testimonio-text">{{ truncateText(testimonio.contenido, 80) }}</p>
            </td>

            <!-- Valoración -->
            <td>
              <div class="stars">
                <lucide-icon *ngFor="let star of [1,2,3,4,5]"
                             name="star"
                             [size]="16"
                             [class.star-filled]="star <= testimonio.valoracion">
                </lucide-icon>
              </div>
            </td>

            <!-- Fecha -->
            <td>
              <span class="fecha">{{ formatDate(testimonio.fecha) }}</span>
            </td>

            <!-- Estado -->
            <td>
              <span class="badge-estado"
                    [class.badge-pendiente]="testimonio.estado === 'pendiente'"
                    [class.badge-rechazado]="testimonio.estado === 'rechazado'">
                {{ testimonio.estado === 'pendiente' ? '⏳ Pendiente' : '✗ Rechazado' }}
              </span>
            </td>

            <!-- Acciones -->
            <td>
              <div class="acciones">
                <button class="btn-icon btn-icon-view"
                        (click)="verTestimonio(testimonio)"
                        title="Ver detalles">
                  <lucide-icon name="eye" [size]="18"></lucide-icon>
                </button>
                <button *ngIf="testimonio.estado === 'pendiente'"
                        class="btn-icon btn-icon-success"
                        (click)="abrirModalPublicar(testimonio)"
                        title="Publicar">
                  <lucide-icon name="check" [size]="18"></lucide-icon>
                </button>
                <button *ngIf="testimonio.estado === 'pendiente'"
                        class="btn-icon btn-icon-danger"
                        (click)="rechazarTestimonio(testimonio.idTestimonio)"
                        title="Rechazar">
                  <lucide-icon name="x" [size]="18"></lucide-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tab Content: Publicaciones -->
  <div *ngIf="activeTab === 'publicaciones'" class="tab-content">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando publicaciones...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && testimoniosPublicados.length === 0" class="empty-state">
      <lucide-icon name="star" [size]="48" class="empty-icon"></lucide-icon>
      <p class="empty-title">No hay testimonios publicados</p>
      <p class="empty-text">Los testimonios aprobados aparecerán aquí</p>
    </div>

    <!-- Header con Botón Crear -->
    <div *ngIf="!loading && testimoniosPublicados.length > 0" class="publicaciones-header">
      <button class="btn-primary" (click)="abrirModalPublicar(null)">
        <lucide-icon name="plus" [size]="18"></lucide-icon>
        <span>Publicar Testimonio</span>
      </button>
    </div>

    <!-- Grid de Cards -->
    <div *ngIf="!loading && testimoniosPublicados.length > 0" class="cards-grid">
      <div *ngFor="let testimonio of testimoniosPublicados" class="card">
        <!-- Foto del Testimonio -->
        <div class="card-image" *ngIf="testimonio.fotoUrl">
          <img [src]="testimonio.fotoUrl" [alt]="testimonio.nombre">
        </div>
        <div class="card-image-placeholder" *ngIf="!testimonio.fotoUrl">
          <lucide-icon name="user" [size]="48" class="placeholder-icon"></lucide-icon>
        </div>

        <!-- Contenido -->
        <div class="card-content">
          <!-- Nombre y Ubicación -->
          <div class="card-header">
            <h3 class="card-nombre">{{ testimonio.nombre }}</h3>
            <div class="card-ubicacion">
              <lucide-icon name="map-pin" [size]="14"></lucide-icon>
              <span>{{ testimonio.ubicacion }}</span>
            </div>
          </div>

          <!-- Valoración -->
          <div class="stars">
            <lucide-icon *ngFor="let star of [1,2,3,4,5]"
                         name="star"
                         [size]="16"
                         [class.star-filled]="star <= testimonio.valoracion">
            </lucide-icon>
          </div>

          <!-- Comentario -->
          <p class="card-comentario">"{{ testimonio.comentario }}"</p>

          <!-- Meta Info -->
          <div class="card-meta">
            <div class="meta-item">
              <lucide-icon name="home" [size]="14"></lucide-icon>
              <span>{{ testimonio.tipoPropiedad }}</span>
            </div>
            <div class="meta-item">
              <lucide-icon name="calendar" [size]="14"></lucide-icon>
              <span>Vendido en {{ testimonio.tiempo }}</span>
            </div>
          </div>

          <!-- Acciones -->
          <div class="card-acciones">
            <button class="btn-secondary" (click)="editarPublicacion(testimonio)">
              <lucide-icon name="edit" [size]="16"></lucide-icon>
              <span>Editar</span>
            </button>
            <button class="btn-danger" (click)="eliminarPublicacion(testimonio.idTestimonio!)">
              <lucide-icon name="trash-2" [size]="16"></lucide-icon>
              <span>Eliminar</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modales -->
<app-modal-enviar-formulario [isVisible]="showModalEnviar"
                             (close)="cerrarModalEnviar()"
                             (success)="onFormularioEnviado()">
</app-modal-enviar-formulario>

<app-modal-ver-testimonio [isVisible]="showModalVer"
                          [testimonio]="testimonioSeleccionado"
                          (close)="cerrarModalVer()">
</app-modal-ver-testimonio>

<app-modal-publicar-testimonio [isVisible]="showModalPublicar"
                               [testimonio]="testimonioParaPublicar"
                               (close)="cerrarModalPublicar()"
                               (submit)="onTestimonioPublicado($event)">
</app-modal-publicar-testimonio>
